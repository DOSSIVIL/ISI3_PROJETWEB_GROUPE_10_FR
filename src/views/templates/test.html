<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Assistant IA - EduConnect</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <style>
        /* Couleurs personnalis√©es */
        :root {
            --primary-gradient: linear-gradient(90deg, #3b82f6, #1d4ed8);
            --secondary-gradient: linear-gradient(90deg, #3b82f6, #2563eb);
            --accent-gradient: linear-gradient(90deg, #3b82f6, #60a5fa);
        }
        
        .gradient-edu {
            background: linear-gradient(90deg, #3b82f6, #1d4ed8);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .gradient-connect {
            background: linear-gradient(90deg, #2563eb, #60a5fa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .gradient-africa {
            background: linear-gradient(90deg, #3b82f6, #60a5fa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .bg-gradient-primary {
            background: linear-gradient(135deg, #1e1b4b 0%, #312e81 100%);
        }
        
        .bg-gradient-secondary {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
        }
        
        /* Styles pour les cat√©gories - TOUS EN BLEU */
        .category-math { background: linear-gradient(135deg, #3b82f6, #1d4ed8); }
        .category-physics { background: linear-gradient(135deg, #2563eb, #1e40af); }
        .category-earth { background: linear-gradient(135deg, #1d4ed8, #1e3a8a); }
        .category-literature { background: linear-gradient(135deg, #60a5fa, #3b82f6); }
        .category-informatique { background: linear-gradient(135deg, #93c5fd, #2563eb); }
        
        .category-badge {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
            color: white;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            background: #3b82f6;
        }
        
        /* Animation de frappe */
        .typing-dots {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .typing-dots span {
            width: 6px;
            height: 6px;
            background-color: #9ca3af;
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out;
        }
        
        .typing-dots span:nth-child(1) { animation-delay: -0.32s; }
        .typing-dots span:nth-child(2) { animation-delay: -0.16s; }
        
        @keyframes typing {
            0%, 80%, 100% { transform: scale(0); opacity: 0.3; }
            40% { transform: scale(1); opacity: 1; }
        }
        
        /* Scrollbar personnalis√©e */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 10px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.5);
        }
        
        /* Glass effect */
        .glass-effect {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        /* Animation slide */
        .slide-up {
            animation: slideUp 0.3s ease-out;
        }
        
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Optimisations mobiles */
        @media (max-width: 768px) {
            .sidebar-mobile-hidden {
                transform: translateX(-100%);
            }
            
            .sidebar-mobile-show {
                transform: translateX(0);
            }
            
            .input-responsive {
                font-size: 16px !important; /* Emp√™che le zoom sur iOS */
            }
            
            .btn-responsive {
                padding: 12px 16px !important;
                font-size: 14px !important;
            }
            
            .text-responsive {
                font-size: 14px !important;
            }
            
            .text-responsive-lg {
                font-size: 16px !important;
            }
            
            /* Emp√™che le "bounce" sur iOS */
            body {
                overflow-x: hidden;
                -webkit-overflow-scrolling: touch;
            }
            
            /* Meilleur clavier mobile */
            textarea {
                max-height: 150px;
            }
        }
        
        /* Am√©liorations tactiles */
        @media (hover: none) and (pointer: coarse) {
            button, 
            .category-btn,
            .conversation-item {
                min-height: 44px;
                min-width: 44px;
            }
            
            .category-btn {
                padding: 16px 12px !important;
            }
        }
        
        /* Dark mode safe */
        @media (prefers-color-scheme: dark) {
            body {
                background: #111827 !important;
            }
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900 touch-manipulation">
    <!-- Loader -->
    <div id="loader" class="fixed inset-0 z-50 flex items-center justify-center bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900">
        <div class="text-center">
            <div class="relative w-24 h-24 mx-auto mb-6">
                <div class="absolute inset-0 border-4 border-solid rounded-full border-t-[#3b82f6] border-r-[#2563eb] border-b-[#1d4ed8] border-l-[#60a5fa] animate-spin"></div>
                <div class="absolute inset-0 flex items-center justify-center">
                    <i class="text-5xl" style="background: linear-gradient(90deg, #3b82f6, #2563eb); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">ü§ñ</i>
                </div>
            </div>
            <p class="text-xl font-medium text-white text-responsive-lg">Chargement d'EduConnect...</p>
            <p class="mt-2 text-sm text-gray-400 text-responsive">Initialisation de l'assistant IA</p>
        </div>
    </div>

    <!-- Conteneur principal -->
    <div id="main-container" class="hidden h-screen overflow-hidden">
        <!-- Header -->
        <header class="sticky top-0 z-40 bg-gradient-primary">
            <div class="px-4 py-3">
                <div class="flex items-center justify-between">
                    <!-- Logo et titre -->
                    <div class="flex items-center space-x-4">
                        <button onclick="toggleSidebar()" class="p-3 rounded-lg glass-effect lg:hidden">
                            <i class="text-xl text-white fas fa-bars"></i>
                        </button>
                        <div class="flex items-center space-x-3">
                            <div class="p-2 rounded-lg glass-effect">
                                <i class="text-2xl" style="background: linear-gradient(90deg, #3b82f6, #2563eb); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">ü§ñ</i>
                            </div>
                            <div>
                                <h1 class="text-lg sm:text-xl lg:text-2xl font-bold whitespace-nowrap">
                                    <span class="gradient-edu">Edu</span><span class="gradient-connect">Connect</span>
                                    <span class="gradient-africa">Africa</span>
                                </h1>
                                <p class="text-xs text-gray-300 text-responsive">Assistant IA √âducatif</p>
                            </div>
                        </div>
                    </div>

                    <!-- Indicateur de statut et info utilisateur -->
                    <div class="flex items-center space-x-3">
                        <div id="userInfo" class="hidden px-3 py-2 text-sm rounded-lg glass-effect">
                            <i class="mr-2 fas fa-user" style="color: #60a5fa"></i>
                            <span id="userName" class="font-medium text-white text-responsive"></span>
                        </div>
                        <div class="hidden px-3 py-2 text-sm rounded-lg md:block glass-effect">
                            <i class="mr-2 fas fa-bolt" style="color: #60a5fa"></i>
                            <span class="font-medium text-white text-responsive">Mistral 7B</span>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Contenu principal -->
        <div class="flex flex-1 h-[calc(100vh-68px)]">
            <!-- Sidebar - Historique des conversations (d√©pliable) -->
            <aside id="sidebar" class="absolute inset-y-0 left-0 z-30 w-64 transform bg-gray-900/95 backdrop-blur-lg lg:relative lg:translate-x-0 sidebar-mobile-hidden transition-transform duration-300 ease-in-out border-r border-gray-700">
                <div class="flex flex-col h-full">
                    <!-- En-t√™te sidebar avec bouton de fermeture -->
                    <div class="flex items-center justify-between p-4 border-b border-gray-700">
                        <h2 class="text-lg font-bold text-white">
                            <i class="mr-2 fas fa-history"></i>Historique
                        </h2>
                        <button onclick="toggleSidebar()" class="p-2 rounded-lg hover:bg-gray-800 lg:hidden">
                            <i class="text-lg text-white fas fa-times"></i>
                        </button>
                    </div>
                    
                    <div class="flex-1 p-4 overflow-y-auto custom-scrollbar">
                        <!-- Bouton Nouvelle Conversation EN BLEU -->
                        <button onclick="newConversation()" class="w-full px-4 py-3 mb-4 text-sm font-medium text-white transition-all rounded-lg bg-gradient-to-r from-[#3b82f6] to-[#1d4ed8] hover:opacity-90 active:scale-95 btn-responsive">
                            <i class="mr-2 fas fa-plus"></i>Nouvelle conversation
                        </button>

                        <!-- Liste des conversations -->
                        <h3 class="mb-3 text-sm font-medium text-gray-400">Conversations r√©centes</h3>
                        <div id="conversationsList" class="space-y-2">
                            <!-- Les conversations seront ajout√©es ici dynamiquement -->
                            <div class="p-3 text-sm text-center text-gray-400">
                                Aucune conversation pr√©c√©dente
                            </div>
                        </div>
                    </div>

                    <!-- Statistiques -->
                    <div class="p-4 border-t border-gray-700">
                        <div class="grid grid-cols-2 gap-2">
                            <div class="p-2 text-center rounded-lg glass-effect">
                                <div class="text-xl font-bold text-white" id="totalConversations">0</div>
                                <div class="text-xs text-gray-400 text-responsive">Conversations</div>
                            </div>
                            <div class="p-2 text-center rounded-lg glass-effect">
                                <div class="text-xl font-bold text-white" id="totalMessages">0</div>
                                <div class="text-xs text-gray-400 text-responsive">Messages</div>
                            </div>
                        </div>
                    </div>
                </div>
            </aside>

            <!-- Overlay pour mobile -->
            <div id="sidebarOverlay" class="fixed inset-0 z-20 hidden bg-black bg-opacity-50 lg:hidden" onclick="toggleSidebar()"></div>

            <!-- Contenu central -->
            <main class="flex-1 flex flex-col overflow-hidden">
                <!-- Section cat√©gories -->
                <div class="p-4 bg-gray-800/50 border-b border-gray-700">
                    <div class="flex flex-col space-y-4">
                        <div class="flex items-center space-x-2">
                            <i class="text-lg" style="color: #60a5fa"></i>
                            <h3 class="text-sm font-medium text-gray-300 text-responsive">S√©lectionnez une cat√©gorie :</h3>
                        </div>
                        <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 gap-2">
                            <button onclick="selectCategory('mathematiques')" class="category-btn p-3 rounded-lg text-white font-medium transition-all hover:scale-105 active:scale-95 category-math btn-responsive">
                                <i class="mr-2 fas fa-calculator"></i>Math√©matiques
                            </button>
                            <button onclick="selectCategory('physique')" class="category-btn p-3 rounded-lg text-white font-medium transition-all hover:scale-105 active:scale-95 category-physics btn-responsive">
                                <i class="mr-2 fas fa-atom"></i>Physique
                            </button>
                            <button onclick="selectCategory('terre')" class="category-btn p-3 rounded-lg text-white font-medium transition-all hover:scale-105 active:scale-95 category-earth btn-responsive">
                                <i class="mr-2 fas fa-globe-africa"></i>Sciences de la Terre
                            </button>
                            <button onclick="selectCategory('litterature')" class="category-btn p-3 rounded-lg text-white font-medium transition-all hover:scale-105 active:scale-95 category-literature btn-responsive">
                                <i class="mr-2 fas fa-book-open"></i>Litt√©rature camerounaise
                            </button>
                            <button onclick="selectCategory('informatique')" class="category-btn p-3 rounded-lg text-white font-medium transition-all hover:scale-105 active:scale-95 category-informatique btn-responsive">
                                <i class="mr-2 fas fa-laptop-code"></i>Informatique
                            </button>
                        </div>
                        <div id="selectedCategory" class="hidden mt-2">
                            <div class="inline-flex items-center px-3 py-1 text-sm rounded-full bg-blue-500">
                                <span id="categoryName" class="font-medium text-white"></span>
                                <button onclick="clearCategory()" class="ml-2 text-white hover:text-gray-300">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Zone de messages -->
                <div id="messagesContainer" class="flex-1 p-4 overflow-y-auto custom-scrollbar">
                    <div id="messages" class="space-y-4 max-w-4xl mx-auto">
                        <!-- Message de bienvenue -->
                        <div class="p-4 md:p-6 rounded-2xl glass-effect slide-up">
                            <div class="flex items-start space-x-4">
                                <div class="flex-shrink-0">
                                    <div class="p-3 rounded-full" style="background: linear-gradient(135deg, #3b82f6, #2563eb)">
                                        <i class="text-2xl text-white fas fa-robot"></i>
                                    </div>
                                </div>
                                <div class="flex-1">
                                    <h3 class="mb-2 text-lg md:text-xl font-bold text-white">
                                        <span class="gradient-edu">Edu</span><span class="gradient-connect">Connect</span> Assistant IA
                                    </h3>
                                    <p class="text-gray-300 text-responsive">
                                        Bienvenue ! Je suis votre assistant √©ducatif bas√© sur Mistral 7B.
                                        <br><br>
                                        <strong class="text-white">Pour commencer :</strong>
                                    </p>
                                    <ol class="mt-2 ml-4 text-gray-300 text-responsive list-decimal">
                                        <li>S√©lectionnez une cat√©gorie ci-dessus</li>
                                        <li>Posez votre question dans la zone de texte en bas</li>
                                        <li>Je vous r√©pondrai dans le contexte de la cat√©gorie choisie</li>
                                    </ol>
                                    <div class="flex items-center mt-4 text-sm" style="color: #60a5fa">
                                        <i class="mr-2 fas fa-lightbulb"></i>
                                        <span class="text-responsive">Les cat√©gories disponibles : Math√©matiques, Physique, Sciences de la Terre, Litt√©rature camerounaise, Informatique</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Zone de saisie fixe en bas -->
                <div class="sticky bottom-0 left-0 right-0 p-3 md:p-4 bg-gradient-to-t from-gray-900 to-transparent border-t border-gray-700">
                    <div class="max-w-4xl mx-auto">
                        <!-- Indicateur de cat√©gorie -->
                        <div id="categoryIndicator" class="hidden mb-3">
                            <div class="inline-flex items-center px-3 py-1 text-sm rounded-full glass-effect">
                                <i class="mr-2 text-white" id="categoryIcon"></i>
                                <span id="currentCategory" class="font-medium text-white text-responsive"></span>
                                <span class="mx-2 text-gray-400">‚Ä¢</span>
                                <span class="text-gray-300 text-responsive">Pr√™t √† r√©pondre</span>
                            </div>
                        </div>

                        <!-- Zone de texte et boutons -->
                        <div class="relative">
                            <textarea id="prompt" rows="2"
                                      class="w-full px-4 py-3 pr-24 text-white placeholder-gray-500 bg-gray-800/70 border border-gray-700 rounded-xl focus:outline-none focus:ring-2 focus:ring-[#3b82f6] focus:border-transparent resize-none input-responsive"
                                      placeholder="Posez votre question √† l'assistant..."
                                      maxlength="1000"></textarea>
                            
                            <div class="absolute bottom-2 right-2 flex space-x-2">
                                <button onclick="clearChat()" class="p-2 text-gray-400 transition-colors rounded-lg hover:text-white hover:bg-gray-700/50">
                                    <i class="text-lg fas fa-trash-alt"></i>
                                </button>
                                <!-- Bouton Envoyer EN BLEU -->
                                <button onclick="sendMessage()" id="sendBtn" 
                                        class="px-4 py-2 font-medium text-white transition-all rounded-lg bg-gradient-to-r from-[#3b82f6] to-[#1d4ed8] hover:opacity-90 active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed btn-responsive">
                                    <i class="mr-2 fas fa-paper-plane"></i><span class="hidden sm:inline">Envoyer</span>
                                </button>
                            </div>
                            
                            <!-- Compteur de caract√®res -->
                            <div class="absolute bottom-2 left-2">
                                <span id="charCount" class="text-xs text-gray-400">0/1000</span>
                            </div>
                        </div>
                        
                        <!-- Indicateur de frappe -->
                        <div id="typingIndicator" class="hidden mt-3 ml-4">
                            <div class="flex items-center space-x-2">
                                <div class="typing-dots">
                                    <span></span>
                                    <span></span>
                                    <span></span>
                                </div>
                                <span class="text-sm text-gray-400 text-responsive">L'assistant r√©dige une r√©ponse...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>

        <!-- Toast notifications -->
        <div id="toast" class="fixed bottom-4 right-4 z-50 hidden max-w-sm">
            <div class="px-6 py-4 text-white rounded-xl shadow-2xl" style="background: linear-gradient(135deg, #3b82f6, #2563eb)">
                <div class="flex items-center space-x-3">
                    <i id="toastIcon" class="text-xl"></i>
                    <div class="flex-1">
                        <p id="toastMessage" class="font-medium text-responsive"></p>
                    </div>
                    <button onclick="hideToast()" class="ml-4 text-white hover:text-gray-200">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==================== CONFIGURATION FIREBASE ====================
        const firebaseConfig = {
            apiKey: "AIzaSyAHnlS177olRKu3WJBO-yTQsd4vNI0MIFs",
            authDomain: "achitectureweb-groupe-10.firebaseapp.com",
            projectId: "achitectureweb-groupe-10",
            storageBucket: "achitectureweb-groupe-10.firebasestorage.app",
            messagingSenderId: "646899550480",
            appId: "1:646899550480:web:687fd4f4b2e0ca646efd95"
        };

        // Variables globales pour Firebase
        let firebaseApp = null;
        let firebaseAuth = null;
        let firebaseDb = null;
        let firebaseInitialized = false;
        
        // Configuration API OpenRouter
        const API_KEY = "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";
        const API_URL = "https://openrouter.ai/api/v1/chat/completions";
        const MODEL = "mistralai/mistral-7b-instruct:free";
        
        // Configuration des cat√©gories
        const categories = {
            mathematiques: {
                name: "Math√©matiques",
                icon: "fa-calculator",
                color: "#3b82f6",
                context: "Vous √™tes un expert en math√©matiques. R√©pondez aux questions de mani√®re pr√©cise et d√©taill√©e, avec des explications claires et des exemples concrets quand n√©cessaire."
            },
            physique: {
                name: "Physique",
                icon: "fa-atom",
                color: "#2563eb",
                context: "Vous √™tes un expert en physique. Fournissez des explications scientifiques pr√©cises, utilisez des formules appropri√©es et expliquez les concepts physiques de mani√®re accessible."
            },
            terre: {
                name: "Sciences de la Terre",
                icon: "fa-globe-africa",
                color: "#1d4ed8",
                context: "Vous √™tes un expert en sciences de la Terre. Parlez de g√©ologie, m√©t√©orologie, oc√©anographie et environnement avec un accent particulier sur l'Afrique et le Cameroun."
            },
            litterature: {
                name: "Litt√©rature camerounaise",
                icon: "fa-book-open",
                color: "#60a5fa",
                context: "Vous √™tes un expert en litt√©rature camerounaise. Parlez des auteurs, ≈ìuvres, mouvements litt√©raires et sp√©cificit√©s culturelles du Cameroun. Mentionnez des auteurs comme Mongo Beti, Ferdinand Oyono, etc."
            },
            informatique: {
                name: "Informatique",
                icon: "fa-laptop-code",
                color: "#93c5fd",
                context: "Vous √™tes un expert en informatique. R√©pondez aux questions sur la programmation, les technologies, les concepts informatiques avec des exemples pratiques et du code quand n√©cessaire."
            }
        };
        
        // Variables globales
        let currentCategory = null;
        let currentConversationId = null;
        let conversations = [];
        let isLoading = false;
        let currentUser = null;
        let userData = null;

        // ==================== INITIALISATION FIREBASE ====================
        async function initFirebase() {
            try {
                // V√©rifier si Firebase est d√©j√† initialis√©
                if (!firebase.apps.length) {
                    firebaseApp = firebase.initializeApp(firebaseConfig);
                } else {
                    firebaseApp = firebase.app();
                }
                
                firebaseAuth = firebase.auth();
                firebaseDb = firebase.firestore();
                firebaseInitialized = true;
                
                console.log("‚úÖ Firebase initialis√© avec succ√®s");
                
                // V√©rifier l'√©tat d'authentification
                firebaseAuth.onAuthStateChanged(async (user) => {
                    if (user) {
                        currentUser = user;
                        await loadUserData(user.uid);
                        await loadUserConversations(user.uid);
                        updateUserInfo();
                    } else {
                        // Rediriger vers la page de connexion si non authentifi√©
                        showToast("Veuillez vous connecter pour utiliser l'assistant", "warning");
                        setTimeout(() => {
                            window.location.href = "/src/views/templates/Connexion.html";
                        }, 2000);
                    }
                });
                
            } catch (error) {
                console.error("‚ùå Erreur d'initialisation Firebase:", error);
                showToast("Erreur de connexion au service", "error");
            }
        }

        // ==================== CHARGEMENT DES DONN√âES UTILISATEUR ====================
        async function loadUserData(userId) {
            try {
                const db = firebase.firestore();
                
                // Essayer d'abord la collection enseignants
                let userRef = db.collection('enseignants').doc(userId);
                let userDoc = await userRef.get();
                
                if (userDoc.exists) {
                    userData = userDoc.data();
                    userData.role = 'enseignant';
                    return;
                }
                
                // Essayer la collection etudiants
                userRef = db.collection('etudiants').doc(userId);
                userDoc = await userRef.get();
                
                if (userDoc.exists) {
                    userData = userDoc.data();
                    userData.role = 'etudiant';
                    return;
                }
                
                console.warn("Aucun profil trouv√© pour l'utilisateur");
                userData = {
                    display_name: currentUser.email.split('@')[0],
                    role: 'utilisateur'
                };
                
            } catch (error) {
                console.error("Erreur lors du chargement des donn√©es utilisateur:", error);
                userData = {
                    display_name: currentUser.email.split('@')[0],
                    role: 'utilisateur'
                };
            }
        }

        // ==================== GESTION DES CONVERSATIONS FIREBASE ====================
        async function saveConversationToFirebase(conversationData) {
            if (!firebaseInitialized || !currentUser) return null;
            
            try {
                const db = firebase.firestore();
                const conversationsRef = db.collection('assistantIA');
                
                const conversation = {
                    userId: currentUser.uid,
                    userName: userData?.display_name || currentUser.email,
                    userEmail: currentUser.email,
                    userRole: userData?.role || 'utilisateur',
                    category: conversationData.category,
                    question: conversationData.question,
                    response: conversationData.response,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    createdAt: new Date().toISOString(),
                    conversationId: conversationData.conversationId
                };
                
                const docRef = await conversationsRef.add(conversation);
                console.log("‚úÖ Conversation sauvegard√©e dans Firebase avec ID:", docRef.id);
                
                return docRef.id;
                
            } catch (error) {
                console.error("‚ùå Erreur lors de la sauvegarde dans Firebase:", error);
                showToast("Erreur lors de la sauvegarde de la conversation", "error");
                return null;
            }
        }

        async function loadUserConversations(userId) {
            if (!firebaseInitialized || !userId) return;
            
            try {
                const db = firebase.firestore();
                const conversationsRef = db.collection('assistantIA');
                
                const querySnapshot = await conversationsRef
                    .where('userId', '==', userId)
                    .orderBy('timestamp', 'desc')
                    .limit(50)
                    .get();
                
                conversations = [];
                
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    conversations.push({
                        id: doc.id,
                        firestoreId: doc.id,
                        title: data.question.substring(0, 30) + (data.question.length > 30 ? '...' : ''),
                        category: data.category,
                        timestamp: data.createdAt || data.timestamp?.toDate().toISOString(),
                        messages: [
                            { role: 'user', content: data.question, timestamp: data.createdAt },
                            { role: 'assistant', content: data.response, timestamp: data.createdAt }
                        ]
                    });
                });
                
                // Mettre √† jour l'interface
                loadConversations();
                showToast(`Chargement de ${conversations.length} conversations`, "info");
                
            } catch (error) {
                console.error("‚ùå Erreur lors du chargement des conversations:", error);
                showToast("Erreur lors du chargement de l'historique", "error");
            }
        }

        // ==================== INITIALISATION ====================
        document.addEventListener('DOMContentLoaded', async () => {
            // Initialiser Firebase
            await initFirebase();
            
            // Configurer le compteur de caract√®res
            const promptInput = document.getElementById('prompt');
            const charCount = document.getElementById('charCount');
            
            promptInput.addEventListener('input', () => {
                const length = promptInput.value.length;
                charCount.textContent = `${length}/1000`;
                
                if (length > 950) {
                    charCount.style.color = '#ef4444';
                } else if (length > 800) {
                    charCount.style.color = '#f59e0b';
                } else {
                    charCount.style.color = '#9ca3af';
                }
            });
            
            // Configurer la saisie (Ctrl+Enter pour envoyer)
            promptInput.addEventListener('keydown', (e) => {
                if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                    sendMessage();
                }
            });
            
            // Cacher le loader et afficher l'interface
            setTimeout(() => {
                document.getElementById('loader').style.display = 'none';
                document.getElementById('main-container').classList.remove('hidden');
                
                if (currentUser) {
                    showToast(`Bienvenue ${userData?.display_name || currentUser.email} !`, 'info');
                }
            }, 1500);
        });

        // ==================== FONCTIONS UTILISATEUR ====================
        function updateUserInfo() {
            if (!userData && !currentUser) return;
            
            const userInfoDiv = document.getElementById('userInfo');
            const userNameSpan = document.getElementById('userName');
            
            if (userData?.display_name) {
                userNameSpan.textContent = userData.display_name;
                userInfoDiv.classList.remove('hidden');
            } else if (currentUser?.email) {
                userNameSpan.textContent = currentUser.email.split('@')[0];
                userInfoDiv.classList.remove('hidden');
            }
        }

        // ==================== GESTION DES CAT√âGORIES ====================
        function selectCategory(categoryKey) {
            if (categories[categoryKey]) {
                currentCategory = categoryKey;
                
                // Mettre √† jour l'interface
                const category = categories[categoryKey];
                document.getElementById('categoryIndicator').classList.remove('hidden');
                document.getElementById('currentCategory').textContent = category.name;
                document.getElementById('categoryIcon').className = `fas ${category.icon}`;
                document.getElementById('categoryIcon').style.color = category.color;
                
                // Ajouter un badge de cat√©gorie dans le chat
                addCategoryMessage(category.name, category.color);
                
                showToast(`Cat√©gorie s√©lectionn√©e : ${category.name}`, 'success');
            }
        }
        
        function clearCategory() {
            currentCategory = null;
            document.getElementById('categoryIndicator').classList.add('hidden');
            showToast('Cat√©gorie d√©s√©lectionn√©e', 'warning');
        }
        
        function addCategoryMessage(categoryName, color) {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'slide-up';
            messageDiv.innerHTML = `
                <div class="inline-flex items-center px-4 py-2 mb-4 rounded-lg" style="background: ${color}20; border-left: 4px solid ${color}">
                    <i class="mr-2" style="color: ${color}"></i>
                    <span class="font-medium text-white">Mode : ${categoryName}</span>
                    <span class="ml-2 text-sm text-gray-300 text-responsive">‚Ä¢ L'assistant r√©pondra dans ce contexte</span>
                </div>
            `;
            messagesDiv.appendChild(messageDiv);
            scrollToBottom();
        }

        // ==================== GESTION DES CONVERSATIONS ====================
        function newConversation() {
            currentConversationId = Date.now().toString();
            
            // Effacer le chat
            document.getElementById('messages').innerHTML = `
                <div class="p-4 md:p-6 rounded-2xl glass-effect slide-up">
                    <div class="flex items-start space-x-4">
                        <div class="flex-shrink-0">
                            <div class="p-3 rounded-full" style="background: linear-gradient(135deg, #3b82f6, #2563eb)">
                                <i class="text-2xl text-white fas fa-robot"></i>
                            </div>
                        </div>
                        <div class="flex-1">
                            <h3 class="mb-2 text-lg md:text-xl font-bold text-white">
                                <span class="gradient-edu">Edu</span><span class="gradient-connect">Connect</span> Assistant IA
                            </h3>
                            <p class="text-gray-300 text-responsive">
                                Nouvelle conversation cr√©√©e !
                                <br><br>
                                <strong class="text-white">Pour commencer :</strong>
                            </p>
                            <ol class="mt-2 ml-4 text-gray-300 text-responsive list-decimal">
                                <li>S√©lectionnez une cat√©gorie ci-dessus</li>
                                <li>Posez votre question dans la zone de texte en bas</li>
                                <li>Je vous r√©pondrai dans le contexte de la cat√©gorie choisie</li>
                            </ol>
                        </div>
                    </div>
                </div>
            `;
            
            if (currentCategory) {
                const category = categories[currentCategory];
                addCategoryMessage(category.name, category.color);
            }
            
            showToast('Nouvelle conversation cr√©√©e', 'success');
            toggleSidebar(); // Fermer le sidebar sur mobile
        }
        
        function loadConversations() {
            const listDiv = document.getElementById('conversationsList');
            const totalMessages = conversations.reduce((total, conv) => total + conv.messages.length, 0);
            
            // Mettre √† jour les statistiques
            document.getElementById('totalConversations').textContent = conversations.length;
            document.getElementById('totalMessages').textContent = totalMessages;
            
            if (conversations.length === 0) {
                listDiv.innerHTML = '<div class="p-3 text-sm text-center text-gray-400">Aucune conversation pr√©c√©dente</div>';
                return;
            }
            
            listDiv.innerHTML = conversations.map(conv => `
                <div onclick="loadFirebaseConversation('${conv.id}')" class="p-3 rounded-lg cursor-pointer glass-effect hover:bg-gray-800/50 transition-colors ${currentConversationId === conv.id ? 'ring-2 ring-[#3b82f6]' : ''}">
                    <div class="flex items-center justify-between mb-1">
                        <span class="text-sm font-medium text-white truncate text-responsive">${conv.title}</span>
                        <span class="text-xs text-gray-400">${formatDate(conv.timestamp)}</span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-xs text-gray-400 text-responsive">
                            ${conv.messages.length} message${conv.messages.length > 1 ? 's' : ''}
                        </span>
                        ${conv.category ? `
                            <div class="category-badge" style="background: ${categories[conv.category]?.color || '#3b82f6'}">
                                <i class="fas ${categories[conv.category]?.icon || 'fa-tag'}"></i>
                                <span class="hidden sm:inline">${categories[conv.category]?.name?.substring(0, 3) || ''}</span>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `).join('');
        }
        
        async function loadFirebaseConversation(firestoreId) {
            try {
                if (!firebaseInitialized) return;
                
                const db = firebase.firestore();
                const conversationRef = db.collection('assistantIA').doc(firestoreId);
                const conversationDoc = await conversationRef.get();
                
                if (!conversationDoc.exists) {
                    showToast("Conversation non trouv√©e", "error");
                    return;
                }
                
                const data = conversationDoc.data();
                
                // Charger la conversation dans l'interface
                currentConversationId = firestoreId;
                currentCategory = data.category;
                
                const messagesDiv = document.getElementById('messages');
                messagesDiv.innerHTML = '';
                
                // Afficher les messages
                addUserMessage(data.question, true, data.createdAt);
                addAIMessage(data.response, true, data.createdAt);
                
                // Mettre √† jour l'interface
                if (currentCategory) {
                    const category = categories[currentCategory];
                    document.getElementById('categoryIndicator').classList.remove('hidden');
                    document.getElementById('currentCategory').textContent = category.name;
                    document.getElementById('categoryIcon').className = `fas ${category.icon}`;
                    document.getElementById('categoryIcon').style.color = category.color;
                }
                
                showToast(`Conversation charg√©e`, 'info');
                toggleSidebar(); // Fermer le sidebar sur mobile
                
            } catch (error) {
                console.error("Erreur lors du chargement de la conversation:", error);
                showToast("Erreur lors du chargement de la conversation", "error");
            }
        }

        // ==================== FONCTION POUR ENVOYER UN MESSAGE ====================
        async function sendMessage() {
            if (isLoading) return;
            
            if (!currentUser) {
                showToast('Veuillez vous connecter pour utiliser l\'assistant', 'warning');
                return;
            }
            
            if (!currentCategory) {
                showToast('Veuillez d\'abord s√©lectionner une cat√©gorie', 'warning');
                return;
            }
            
            const prompt = document.getElementById('prompt').value.trim();
            if (!prompt) {
                showToast('Veuillez entrer un message', 'warning');
                return;
            }
            
            // Cr√©er une nouvelle conversation si n√©cessaire
            if (!currentConversationId) {
                newConversation();
            }
            
            // Ajouter le message utilisateur avec l'heure
            const userTimestamp = new Date();
            addUserMessage(prompt, false, userTimestamp.toISOString());
            
            // Effacer le champ de saisie
            document.getElementById('prompt').value = '';
            document.getElementById('charCount').textContent = '0/1000';
            document.getElementById('charCount').style.color = '#9ca3af';
            
            // Afficher l'indicateur de frappe
            document.getElementById('typingIndicator').classList.remove('hidden');
            
            isLoading = true;
            document.getElementById('sendBtn').disabled = true;
            
            // Pr√©parer le contexte de la cat√©gorie
            const category = categories[currentCategory];
            const systemPrompt = category.context + "\n\nR√©ponds en fran√ßais de mani√®re claire et d√©taill√©e.";
            
            // Pr√©parer les donn√©es
            const requestData = {
                model: MODEL,
                messages: [
                    {
                        role: "system",
                        content: systemPrompt
                    },
                    {
                        role: "user",
                        content: prompt
                    }
                ],
                temperature: 0.7,
                max_tokens: 400
            };
            
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${API_KEY}`,
                        'HTTP-Referer': window.location.origin,
                        'X-Title': 'EduConnect Africa'
                    },
                    body: JSON.stringify(requestData)
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error?.message || `Erreur HTTP ${response.status}`);
                }
                
                // Retirer l'indicateur de frappe
                document.getElementById('typingIndicator').classList.add('hidden');
                
                // Afficher la r√©ponse avec l'heure
                if (data.choices && data.choices[0]) {
                    const content = data.choices[0].message.content;
                    const aiTimestamp = new Date();
                    addAIMessage(content, false, aiTimestamp.toISOString());
                    
                    // Sauvegarder la conversation dans Firebase
                    const conversationData = {
                        conversationId: currentConversationId,
                        category: currentCategory,
                        question: prompt,
                        response: content
                    };
                    
                    await saveConversationToFirebase(conversationData);
                    
                    // Recharger les conversations
                    await loadUserConversations(currentUser.uid);
                    
                    showToast(`R√©ponse re√ßue (${data.usage?.total_tokens || 0} tokens)`, 'success');
                } else {
                    throw new Error('Aucune r√©ponse g√©n√©r√©e');
                }
                
            } catch (error) {
                console.error('Erreur:', error);
                document.getElementById('typingIndicator').classList.add('hidden');
                const errorTimestamp = new Date();
                addAIMessage(`‚ùå D√©sol√©, une erreur s'est produite :\n\n${error.message}\n\nVeuillez r√©essayer.`, false, errorTimestamp.toISOString());
                showToast(`Erreur: ${error.message}`, 'error');
            } finally {
                isLoading = false;
                document.getElementById('sendBtn').disabled = false;
                scrollToBottom();
            }
        }

        // ==================== FONCTIONS POUR G√âRER LES MESSAGES ====================
        function addUserMessage(content, fromHistory = false, timestamp = null) {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            const time = timestamp ? new Date(timestamp) : new Date();
            const timeString = formatTime(time);
            
            messageDiv.className = `slide-up ${fromHistory ? '' : 'ml-auto max-w-3/4'}`;
            messageDiv.innerHTML = `
                <div class="flex ${fromHistory ? '' : 'justify-end'}">
                    <div class="${fromHistory ? 'bg-gray-800/50' : 'bg-gradient-to-r from-[#3b82f6] to-[#1d4ed8]'} p-3 md:p-4 rounded-2xl ${fromHistory ? 'max-w-full' : 'max-w-3/4'}" style="${fromHistory ? '' : 'border-top-right-radius: 4px;'}">
                        <div class="flex items-center justify-between mb-1">
                            <span class="text-xs font-medium ${fromHistory ? 'text-gray-400' : 'text-white'}">
                                <i class="mr-1 fas fa-user"></i>Vous
                            </span>
                            <span class="text-xs ${fromHistory ? 'text-gray-500' : 'text-blue-100'}">${timeString}</span>
                        </div>
                        <p class="text-white whitespace-pre-wrap text-responsive">${escapeHtml(content)}</p>
                        ${!fromHistory && currentCategory ? `
                            <div class="mt-2 flex justify-end">
                                <div class="category-badge" style="background: ${categories[currentCategory]?.color || '#3b82f6'}">
                                    <i class="fas ${categories[currentCategory]?.icon || 'fa-tag'}"></i>
                                    <span>${categories[currentCategory]?.name?.substring(0, 3) || ''}</span>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
            messagesDiv.appendChild(messageDiv);
            if (!fromHistory) scrollToBottom();
        }
        
        function addAIMessage(content, fromHistory = false, timestamp = null) {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            const time = timestamp ? new Date(timestamp) : new Date();
            const timeString = formatTime(time);
            
            messageDiv.className = 'slide-up';
            messageDiv.innerHTML = `
                <div class="flex items-start space-x-3">
                    <div class="flex-shrink-0">
                        <div class="p-3 rounded-full" style="background: ${categories[currentCategory]?.color || '#3b82f6'}">
                            <i class="text-lg text-white fas fa-robot"></i>
                        </div>
                    </div>
                    <div class="flex-1">
                        <div class="flex items-center justify-between mb-1">
                            <span class="text-xs font-medium text-gray-400">
                                <i class="mr-1 ${categories[currentCategory]?.icon || 'fa-robot'}"></i>
                                ${categories[currentCategory]?.name || 'Assistant'} ‚Ä¢ Mistral 7B
                            </span>
                            <span class="text-xs text-gray-500">${timeString}</span>
                        </div>
                        <div class="p-3 md:p-4 rounded-xl glass-effect">
                            <div class="text-gray-300 whitespace-pre-wrap text-responsive">${formatResponse(content)}</div>
                        </div>
                    </div>
                </div>
            `;
            messagesDiv.appendChild(messageDiv);
            if (!fromHistory) scrollToBottom();
        }

        // ==================== FONCTIONS UTILITAIRES ====================
        function clearChat() {
            if (confirm('Voulez-vous vraiment effacer cette conversation ?')) {
                const messagesDiv = document.getElementById('messages');
                messagesDiv.innerHTML = `
                    <div class="p-4 md:p-6 rounded-2xl glass-effect slide-up">
                        <div class="flex items-start space-x-4">
                            <div class="flex-shrink-0">
                                <div class="p-3 rounded-full" style="background: linear-gradient(135deg, #3b82f6, #2563eb)">
                                    <i class="text-2xl text-white fas fa-robot"></i>
                                </div>
                            </div>
                            <div class="flex-1">
                                <h3 class="mb-2 text-lg md:text-xl font-bold text-white">
                                    <span class="gradient-edu">Edu</span><span class="gradient-connect">Connect</span> Assistant IA
                                </h3>
                                <p class="text-gray-300 text-responsive">
                                    Conversation effac√©e.
                                    <br><br>
                                    <strong class="text-white">Pour recommencer :</strong>
                                </p>
                                <ol class="mt-2 ml-4 text-gray-300 text-responsive list-decimal">
                                    <li>S√©lectionnez une cat√©gorie ci-dessus</li>
                                    <li>Posez votre question dans la zone de texte en bas</li>
                                </ol>
                            </div>
                        </div>
                    </div>
                `;
                
                if (currentCategory) {
                    const category = categories[currentCategory];
                    addCategoryMessage(category.name, category.color);
                }
                
                showToast('Conversation effac√©e', 'warning');
            }
        }
        
        function formatResponse(text) {
            return escapeHtml(text)
                .replace(/\n/g, '<br>')
                .replace(/\*\*(.*?)\*\*/g, '<strong class="text-white">$1</strong>')
                .replace(/\*(.*?)\*/g, '<em class="italic">$1</em>')
                .replace(/^### (.*$)/gm, '<h3 class="text-lg font-bold mt-4 mb-2 text-white">$1</h3>')
                .replace(/^## (.*$)/gm, '<h2 class="text-xl font-bold mt-6 mb-3 text-white">$1</h2>')
                .replace(/^# (.*$)/gm, '<h1 class="text-2xl font-bold mt-8 mb-4 text-white">$1</h1>')
                .replace(/^- (.*$)/gm, '<li class="ml-4">$1</li>')
                .replace(/`([^`]+)`/g, '<code class="px-1 py-0.5 bg-gray-800 rounded text-sm">$1</code>');
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function formatTime(date) {
            return date.toLocaleTimeString('fr-FR', { 
                hour: '2-digit', 
                minute: '2-digit',
                hour12: false
            });
        }
        
        function formatDate(isoString) {
            const date = new Date(isoString);
            const now = new Date();
            const diff = now - date;
            
            if (diff < 86400000) { // Moins d'un jour
                return formatTime(date);
            } else {
                return date.toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit' });
            }
        }
        
        function scrollToBottom() {
            const container = document.getElementById('messagesContainer');
            setTimeout(() => {
                container.scrollTo({
                    top: container.scrollHeight,
                    behavior: 'smooth'
                });
            }, 100);
        }
        
        // ==================== GESTION DU SIDEBAR ====================
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            
            if (sidebar.classList.contains('sidebar-mobile-hidden')) {
                sidebar.classList.remove('sidebar-mobile-hidden');
                overlay.classList.remove('hidden');
                document.body.style.overflow = 'hidden'; // Emp√™che le scroll du body
            } else {
                sidebar.classList.add('sidebar-mobile-hidden');
                overlay.classList.add('hidden');
                document.body.style.overflow = ''; // R√©tablit le scroll
            }
        }

        // ==================== FONCTIONS POUR LES NOTIFICATIONS ====================
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            const toastIcon = document.getElementById('toastIcon');
            
            switch(type) {
                case 'success':
                    toastIcon.className = 'fas fa-check-circle';
                    break;
                case 'error':
                    toastIcon.className = 'fas fa-exclamation-circle';
                    break;
                case 'warning':
                    toastIcon.className = 'fas fa-exclamation-triangle';
                    break;
                default:
                    toastIcon.className = 'fas fa-info-circle';
            }
            
            toastMessage.textContent = message;
            toast.classList.remove('hidden');
            
            setTimeout(() => hideToast(), 4000);
        }
        
        function hideToast() {
            document.getElementById('toast').classList.add('hidden');
        }

        // ==================== GESTION DU RESPONSIVE ====================
        function handleResize() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            
            if (window.innerWidth >= 1024) {
                // Sur desktop, toujours montrer le sidebar
                sidebar.classList.remove('sidebar-mobile-hidden');
                overlay.classList.add('hidden');
                document.body.style.overflow = '';
            } else {
                // Sur mobile, cacher le sidebar
                sidebar.classList.add('sidebar-mobile-hidden');
                overlay.classList.add('hidden');
                document.body.style.overflow = '';
            }
        }
        
        // √âcouter les changements de taille
        window.addEventListener('resize', handleResize);
        // Initialiser
        handleResize();

        // ==================== GESTION DES TOUCHES ====================
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                const sidebar = document.getElementById('sidebar');
                if (!sidebar.classList.contains('sidebar-mobile-hidden')) {
                    toggleSidebar();
                }
            }
        });
    </script>
</body>
</html>