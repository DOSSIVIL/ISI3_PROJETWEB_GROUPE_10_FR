<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Assistant IA - EduConnect</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
    />
    <style>
      @keyframes typing {
        from {
          width: 0;
        }
        to {
          width: 100%;
        }
      }
      .typing-cursor::after {
        content: "|";
        animation: blink 1s step-end infinite;
      }
      @keyframes blink {
        50% {
          opacity: 0;
        }
      }
    </style>
  </head>
  <body
    class="min-h-screen text-gray-100 bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900"
  >
    <div class="flex flex-col h-screen max-w-4xl p-4 mx-auto">
      <!-- Header -->
      <header
        class="flex items-center justify-between py-4 border-b border-gray-700"
      >
        <h1
          class="text-2xl font-bold text-transparent sm:text-3xl bg-gradient-to-r from-yellow-400 via-pink-500 to-purple-500 bg-clip-text"
        >
          Assistant IA EduConnect
        </h1>
        <span class="text-sm text-gray-400"
          >Powered by Groq • Llama 3.1 8B</span
        >
      </header>

      <!-- Zone messages -->
      <div
        id="chat-messages"
        class="flex-1 px-2 py-6 space-y-6 overflow-y-auto"
      >
        <!-- Les messages seront ajoutés ici dynamiquement -->
      </div>

      <!-- Zone input -->
      <div class="pt-4 border-t border-gray-700">
        <div class="flex gap-3">
          <textarea
            id="user-input"
            rows="1"
            placeholder="Pose-moi une question sur tes cours, devoirs, orientation, méthodologie..."
            class="flex-1 px-5 py-4 text-gray-100 placeholder-gray-400 transition-all border border-gray-600 resize-none rounded-2xl bg-gray-800/70 focus:border-yellow-400 focus:outline-none focus:ring-1 focus:ring-yellow-400/30"
            autocomplete="off"
          ></textarea>
          <button
            id="send-btn"
            class="px-6 py-4 font-semibold transition-all shadow-lg bg-gradient-to-r from-yellow-500 to-pink-600 rounded-2xl hover:brightness-110 hover:scale-105"
          >
            <i class="fas fa-paper-plane"></i>
          </button>
        </div>
        <p class="mt-2 text-xs text-center text-gray-500">
          L’assistant peut faire des erreurs. Vérifie les informations
          importantes.
        </p>
      </div>
    </div>

    <script>
      // ==========================================
      // CONFIGURATION
      // ==========================================
      const GROQ_API_KEY =
        "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"; // ← METS TA CLÉ ICI
      const MODEL = "llama-3.1-8b-instant"; // ou "mixtral-8x7b-32768" ou "gemma2-9b-it"

      const chatMessages = document.getElementById("chat-messages");
      const userInput = document.getElementById("user-input");
      const sendBtn = document.getElementById("send-btn");

      let isProcessing = false;

      // ==========================================
      // FONCTIONS UTILITAIRES
      // ==========================================
      function addMessage(content, isUser = false, isLoading = false) {
        const div = document.createElement("div");
        div.className = `flex ${
          isUser ? "justify-end" : "justify-start"
        } max-w-[90%]`; // max-w pour éviter les lignes trop longues

        const bubble = document.createElement("div");
        bubble.className = `
        px-5 py-3 rounded-2xl text-sm leading-relaxed
        ${
          isUser
            ? "bg-gradient-to-r from-yellow-600 to-pink-600 text-white"
            : "bg-gray-800/80 backdrop-blur-sm border border-gray-700 text-gray-100"
        }
      `;

        if (isLoading) {
          bubble.innerHTML =
            '<i class="text-yellow-400 fas fa-circle-notch fa-spin"></i> Réflexion en cours...';
        } else {
          bubble.innerHTML = content.replace(/\n/g, "<br>");
        }

        div.appendChild(bubble);
        chatMessages.appendChild(div);
        chatMessages.scrollTop = chatMessages.scrollHeight;

        return bubble; // retourne l’élément pour pouvoir le modifier plus tard si besoin
      }

      async function sendToGroq(message) {
        try {
          const response = await fetch(
            "https://api.groq.com/openai/v1/chat/completions",
            {
              method: "POST",
              headers: {
                Authorization: `Bearer ${GROQ_API_KEY}`,
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                model: MODEL,
                messages: [
                  {
                    role: "system",
                    content:
                      "Tu es un assistant pédagogique très pédagogue, encourageant, clair et précis. Tu réponds toujours en français, de manière structurée quand c’est utile. Tu aides des étudiants à mieux comprendre leurs cours, devoirs, méthodologie de travail, orientation...",
                  },
                  { role: "user", content: message },
                ],
                temperature: 0.7,
                max_tokens: 1200,
                top_p: 0.95,
                stream: false,
              }),
            }
          );

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(
              errorData.error?.message || `Erreur HTTP ${response.status}`
            );
          }

          const data = await response.json();
          return data.choices[0].message.content.trim();
        } catch (err) {
          console.error(err);
          return `Désolé, il y a eu un problème : ${err.message}`;
        }
      }

      // ==========================================
      // GESTION DE L’ENVOI
      // ==========================================
      async function handleSend() {
        if (isProcessing) return;
        const text = userInput.value.trim();
        if (!text) return;

        isProcessing = true;
        sendBtn.disabled = true;
        userInput.disabled = true;

        addMessage(text, true);

        const loadingBubble = addMessage("", false, true);

        try {
          const answer = await sendToGroq(text);
          loadingBubble.innerHTML = answer.replace(/\n/g, "<br>");
        } catch (err) {
          loadingBubble.innerHTML = `Erreur : ${err.message}`;
        }

        userInput.value = "";
        userInput.disabled = false;
        sendBtn.disabled = false;
        isProcessing = false;
        userInput.focus();
      }

      // ==========================================
      // ÉVÉNEMENTS
      // ==========================================
      sendBtn.onclick = handleSend;

      userInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          handleSend();
        }
      });

      // Auto-resize textarea
      userInput.addEventListener("input", () => {
        userInput.style.height = "auto";
        userInput.style.height = userInput.scrollHeight + "px";
      });

      // Focus au chargement
      userInput.focus();
    </script>
  </body>
</html>
